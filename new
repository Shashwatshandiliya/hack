// src/components/EntitlementUserView/EntitlementUserView.tsx
import * as React from "react";
import axios from "axios";
import Grid from "@mui/material/Grid";
import Button from "@mui/material/Button";
import Box from "@mui/material/Box";
import MaterialTable from "../../../Root/components/MaterialTable";
import {
  InputAdornment,
  TextField,
  Typography,
  CircularProgress,
  Divider,
  Autocomplete,
} from "@mui/material";
import AddCircleIcon from "@mui/icons-material/AddCircle";
import SearchIcon from "@mui/icons-material/Search";
import { Tabs } from "antd";
import Drawer from "@mui/material/Drawer";
import styles from "./EntitlementUserView.module.css";
import EditIcon from "@mui/icons-material/Edit";
import DeleteIcon from "@mui/icons-material/Delete";

const { TabPane } = Tabs;

interface AccountRow {
  accountOwner: string;
  accountName: string;
  accountType: string;
  accessRoles: { roleName: string }[];
  accountStatus: string;
}

interface EntitlementRow {
  entitlementName: string;
  entitlementDescription: string;
  entitlementOwner: string;
  isPrivileged: string;
}

export default function EntitlementUserView({
  onNavigate,
  onEditAccount,
}: {
  onNavigate?: (tab: string) => void;
  onEditAccount?: (id: string) => void;
}) {
  const [activeTab, setActiveTab] = React.useState<"1" | "2">("1");
  const [drawerOpen, setDrawerOpen] = React.useState(false);
  const [drawerData, setDrawerData] = React.useState<any>(null);
  const [searchTerm, setSearchTerm] = React.useState("");
  const [selectedApp, setSelectedApp] = React.useState("SAIL");
  const [appList, setAppList] = React.useState<string[]>([]);

  const [accounts, setAccounts] = React.useState<AccountRow[]>([]);
  const [entitlements, setEntitlements] = React.useState<EntitlementRow[]>([]);
  const [loading, setLoading] = React.useState(false);
  const [error, setError] = React.useState("");

  const loadAppList = async () => {
    try {
      const { data } = await axios.get("http://mc.shashwat.com:69696/allappplciation");
      const appNames = data.map((app: any) => app.appName);
      setAppList(appNames);
    } catch {
      setError("Failed to load application list");
    }
  };

  const loadAllAccounts = async () => {
    setError("");
    try {
      setLoading(true);
      const { data } = await axios.get(
        `https://uklvauems02a.uk.standardchartered.com:32447/restService/onecert/v1/account?currentPage=1&pageSize=10`,
        {
          headers: { applicationName: selectedApp }
        }
      );
      setAccounts(data.accounts || []);
    } catch {
      setError("Failed to load accounts");
    } finally {
      setLoading(false);
    }
  };

  const loadAllEntitlements = async () => {
    setError("");
    try {
      setLoading(true);
      const { data } = await axios.get(
        `http://mc.shashwat.com:69696/restService/one/entity`,
        {
          headers: { applicationName: selectedApp }
        }
      );
      setEntitlements(data.entitlements || []);
    } catch {
      setError("Failed to load entitlements");
    } finally {
      setLoading(false);
    }
  };

  const handleSearch = async () => {
    setError("");
    if (!searchTerm) {
      activeTab === "1" ? loadAllAccounts() : loadAllEntitlements();
      return;
    }
    try {
      setLoading(true);
      if (activeTab === "1") {
        const { data } = await axios.get(
          `http://mc.shashwat.com:69696/restService/one/account/${searchTerm}`
        );
        setAccounts(data ? [data] : []);
      } else {
        const { data } = await axios.get(
          `http://mc.shashwat.com:69696/restService/one/entitlement/${searchTerm}`
        );
        setEntitlements(data ? [data] : []);
      }
    } catch {
      setError("No results found");
    } finally {
      setLoading(false);
    }
  };

  React.useEffect(() => {
    loadAppList();
  }, []);

  React.useEffect(() => {
    if (activeTab === "1") loadAllAccounts();
    else loadAllEntitlements();
  }, [activeTab, selectedApp]);

  const headCellsAccounts = [
    { accessorKey: "accountOwner", header: "Account Owner" },
    { accessorKey: "accountName", header: "Account Name" },
    {
      accessorKey: "accessRoles",
      header: "Roles",
      Cell: ({ cell }: any) =>
        (cell.getValue() as { roleName: string }[])
          .map((r) => r.roleName)
          .join(", "),
    },
    {
      accessorKey: "accountStatus",
      header: "Status",
      Cell: ({ cell }: any) => {
        const v = (cell.getValue() as string).toLowerCase();
        const active = v === "active";
        return (
          <span
            style={{
              backgroundColor: active ? "#2BCBC11A" : "#ff00001A",
              color: active ? "#2BCBC1" : "#ff0000",
              padding: "0.25rem 0.5rem",
              borderRadius: "20px",
            }}
          >
            {active ? "Enabled" : "Inactive"}
          </span>
        );
      },
    },
    { accessorKey: "accountType", header: "Account Type" },
  ];

  const headCellsEntitlements = [
    { accessorKey: "entitlementName", header: "Name" },
    { accessorKey: "entitlementDescription", header: "Description" },
    { accessorKey: "entitlementOwner", header: "Owner" },
    { accessorKey: "isPrivileged", header: "Privileged" },
  ];

  const openDrawer = (row: any) => {
    setDrawerData(row);
    setDrawerOpen(true);
  };

  const deleteAccount = async (accountName: string) => {
    try {
      await axios.post(
        "http://mc.shashwat.com:69696/restService/one/Delete",
        { accountName }
      );
      loadAllAccounts();
      setDrawerOpen(false);
    } catch {
      alert("Failed to delete account");
    }
  };

  return (
    <div className={styles.container}>
      <Typography fontFamily="Poppins" sx={{ fontWeight: 600, fontSize: 24, color: "white", mb: 3 }}>
        Entitlement Users
      </Typography>

      {activeTab === "1" && (
        <Grid container spacing={2} alignItems="center" justifyContent="space-between" sx={{ mb: 3 }}>
          <Grid item xs={12} sm={6} md={4}>
            <Autocomplete
              size="small"
              options={appList}
              value={selectedApp}
              onChange={(event, newValue) => {
                if (newValue) setSelectedApp(newValue);
              }}
              renderInput={(params) => (
                <TextField
                  {...params}
                  label="Select Application"
                  InputProps={{
                    ...params.InputProps,
                    sx: { backgroundColor: "#1E252D", color: "white" },
                  }}
                  InputLabelProps={{ sx: { color: "#CBCBCB" } }}
                  fullWidth
                />
              )}
            />
          </Grid>

          <Grid item xs={12} sm={6} md={5}>
            <Box sx={{ display: "flex", gap: 1 }}>
              <TextField
                size="small"
                placeholder="Search by owner/name"
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                InputProps={{
                  startAdornment: (
                    <InputAdornment position="start">
                      <SearchIcon sx={{ color: "#CBCBCB" }} />
                    </InputAdornment>
                  ),
                  sx: { backgroundColor: "#1E252D", color: "white", borderRadius: 2 },
                }}
                fullWidth
              />
              <Button
                variant="contained"
                onClick={handleSearch}
                sx={{
                  backgroundColor: "#007BFF",
                  color: "white",
                  fontWeight: 600,
                  borderRadius: 2,
                  textTransform: "none",
                }}
              >
                Search
              </Button>
            </Box>
          </Grid>

          <Grid item xs={12} sm={6} md={3} textAlign="right">
            <Button
              variant="contained"
              startIcon={<AddCircleIcon />}
              onClick={() => onNavigate?.("create-account")}
              sx={{ height: 40, fontWeight: 600, fontSize: 14 }}
            >
              Create Account
            </Button>
          </Grid>
        </Grid>
      )}

      <Tabs
        activeKey={activeTab}
        onChange={(k) => {
          setActiveTab(k as "1" | "2");
          setSearchTerm("");
          setDrawerOpen(false);
        }}
        className={styles.tabs}
      >
        <TabPane key="1" tab={<span style={{ fontWeight: 600, color: activeTab === "1" ? "#007BFF" : "#8D8D8D" }}>Accounts</span>} />
        <TabPane key="2" tab={<span style={{ fontWeight: 600, color: activeTab === "2" ? "#007BFF" : "#8D8D8D" }}>Entitlements</span>} />
      </Tabs>

      <Box className={styles.tableSection}>...</Box>
      <Drawer>...</Drawer>
    </div>
  );
}
