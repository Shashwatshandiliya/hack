import * as React from "react";
import Grid from "@mui/material/Grid";
import IconButton from "@mui/material/IconButton";
import Button from "@mui/material/Button";
import Box from "@mui/material/Box";
import Typography from "@mui/material/Typography";
import TextField from "@mui/material/TextField";
import Select from "@mui/material/Select";
import MenuItem from "@mui/material/MenuItem";
import FormControl from "@mui/material/FormControl";
import InputLabel from "@mui/material/InputLabel";
import Checkbox from "@mui/material/Checkbox";
import FormControlLabel from "@mui/material/FormControlLabel";
import InputAdornment from "@mui/material/InputAdornment";
import CalendarTodayIcon from "@mui/icons-material/CalendarToday";
import SearchIcon from "@mui/icons-material/Search";
import styles from "./ReportsView.module.css";
import axios from "axios";
import { saveAs } from "file-saver";
import * as XLSX from "xlsx";
import jsPDF from "jspdf";
import "jspdf-autotable";

interface Application {
  appUID: number;
  appName: string;
  appDesc: string;
  appOwner: string;
  createdDate: string;
  lastUpdated: string;
}

interface ReportField {
  id: string;
  label: string;
  selected: boolean;
}

const ReportsView: React.FC = () => {
  const [applications, setApplications] = React.useState<Application[]>([]);
  const [selectedApplication, setSelectedApplication] = React.useState<string>("all");
  const [reportFormat, setReportFormat] = React.useState<"csv" | "excel" | "pdf" | "json">("csv");
  const [startDate, setStartDate] = React.useState<string>("");
  const [endDate, setEndDate] = React.useState<string>("");
  const [bankId, setBankId] = React.useState<string>("");
  const [previewData, setPreviewData] = React.useState<any[]>([]);
  const [isLoading, setIsLoading] = React.useState<boolean>(false);
  const [reportFields, setReportFields] = React.useState<ReportField[]>([
    { id: "appName", label: "Application Name", selected: true },
    { id: "appDesc", label: "Description", selected: true },
    { id: "appOwner", label: "Owner", selected: true },
    { id: "createdDate", label: "Created Date", selected: true },
    { id: "lastUpdated", label: "Last Updated", selected: true },
    { id: "contactDL", label: "Contact DL", selected: false },
    { id: "isActive", label: "Active Status", selected: false },
    { id: "totalFeatures", label: "Total Features", selected: false },
    { id: "totalActions", label: "Total Actions", selected: false },
  ]);

  React.useEffect(() => {
    const fetchApplications = async () => {
      try {
        setIsLoading(true);
        const resp = await axios.get<Application[]>(
          "https://uklvauems02a.uk.standardchartered.com:32442/fmces/v1/application/all"
        );
        setApplications(resp.data);
      } catch (error) {
        console.error("Error fetching applications", error);
      } finally {
        setIsLoading(false);
      }
    };

    fetchApplications();
  }, []);

  const handleFieldToggle = (id: string) => {
    setReportFields(fields => 
      fields.map(field => 
        field.id === id ? { ...field, selected: !field.selected } : field
      )
    );
  };

  const handlePreview = async () => {
    try {
      setIsLoading(true);
      
      // Filter applications based on selection
      let filteredApps = [...applications];
      
      // Apply application filter
      if (selectedApplication !== "all") {
        filteredApps = filteredApps.filter(app => 
          app.appName === selectedApplication
        );
      }
      
      // Apply date range filter
      if (startDate && endDate) {
        filteredApps = filteredApps.filter(app => {
          const created = new Date(app.createdDate);
          const start = new Date(startDate);
          const end = new Date(endDate);
          return created >= start && created <= end;
        });
      }
      
      // Apply bank ID filter
      if (bankId) {
        // This would require an API call to get accounts by bank ID
        // For demo purposes, we'll just filter by appOwner
        filteredApps = filteredApps.filter(app => 
          app.appOwner.toLowerCase().includes(bankId.toLowerCase())
        );
      }
      
      // Select only the chosen fields
      const selectedFields = reportFields.filter(f => f.selected).map(f => f.id);
      const preview = filteredApps.map(app => {
        const result: any = {};
        selectedFields.forEach(field => {
          result[field] = (app as any)[field] || "N/A";
        });
        return result;
      });
      
      setPreviewData(preview);
    } catch (error) {
      console.error("Error generating preview", error);
    } finally {
      setIsLoading(false);
    }
  };

  const handleDownload = () => {
    if (previewData.length === 0) {
      alert("No data to download. Please generate a preview first.");
      return;
    }
    
    const selectedFields = reportFields.filter(f => f.selected).map(f => f.id);
    const headers = reportFields
      .filter(f => f.selected)
      .map(f => f.label);
    
    switch (reportFormat) {
      case "csv":
        downloadCSV(previewData, headers, selectedFields);
        break;
      case "excel":
        downloadExcel(previewData, headers, selectedFields);
        break;
      case "pdf":
        downloadPDF(previewData, headers, selectedFields);
        break;
      case "json":
        downloadJSON(previewData);
        break;
    }
  };

  const downloadCSV = (data: any[], headers: string[], fields: string[]) => {
    const csvRows = [];
    
    // Add headers
    csvRows.push(headers.join(","));
    
    // Add data rows
    data.forEach(item => {
      const row = fields.map(field => {
        const value = item[field];
        return typeof value === "string" ? `"${value.replace(/"/g, '""')}"` : value;
      });
      csvRows.push(row.join(","));
    });
    
    const csvString = csvRows.join("\n");
    const blob = new Blob([csvString], { type: "text/csv;charset=utf-8;" });
    saveAs(blob, `application_report_${new Date().toISOString().slice(0, 10)}.csv`);
  };

  const downloadExcel = (data: any[], headers: string[], fields: string[]) => {
    const worksheet = XLSX.utils.json_to_sheet(
      data.map(item => {
        const row: any = {};
        headers.forEach((header, index) => {
          row[header] = item[fields[index]];
        });
        return row;
      })
    );
    
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Applications");
    XLSX.writeFile(workbook, `application_report_${new Date().toISOString().slice(0, 10)}.xlsx`);
  };

  const downloadPDF = (data: any[], headers: string[], fields: string[]) => {
    const doc = new jsPDF();
    const title = "Application Report";
    
    // Add title
    doc.setFontSize(18);
    doc.text(title, 14, 15);
    
    // Add filters info
    doc.setFontSize(10);
    let filterText = `Generated on: ${new Date().toLocaleDateString()}`;
    
    if (selectedApplication !== "all") {
      filterText += ` | Application: ${selectedApplication}`;
    }
    
    if (startDate && endDate) {
      filterText += ` | Date Range: ${new Date(startDate).toLocaleDateString()} - ${new Date(endDate).toLocaleDateString()}`;
    }
    
    if (bankId) {
      filterText += ` | Bank ID: ${bankId}`;
    }
    
    doc.text(filterText, 14, 25);
    
    // Prepare table data
    const tableData = data.map(item => 
      fields.map(field => item[field])
    );
    
    // Add table
    (doc as any).autoTable({
      head: [headers],
      body: tableData,
      startY: 30,
      theme: "grid",
      styles: { fontSize: 9, cellPadding: 2 },
      headStyles: { fillColor: [41, 128, 185] }
    });
    
    doc.save(`application_report_${new Date().toISOString().slice(0, 10)}.pdf`);
  };

  const downloadJSON = (data: any[]) => {
    const jsonString = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonString], { type: "application/json" });
    saveAs(blob, `application_report_${new Date().toISOString().slice(0, 10)}.json`);
  };

  return (
    <div className={styles.container}>
      {/* Header */}
      <div className={styles.header}>
        <Grid container alignItems="center" justifyContent="space-between">
          <Typography sx={{ fontWeight: 500, fontSize: 20 }}>Reports</Typography>
        </Grid>
      </div>

      {/* Report Configuration */}
      <div className={styles.configSection}>
        <Box sx={{ border: '1px solid #444', p: 2, borderRadius: 1, backgroundColor: '#1A2028' }}>
          <Typography variant="h6" sx={{ color: 'white', mb: 2 }}>Generate Report</Typography>
          
          <Grid container spacing={3}>
            {/* Application Selection */}
            <Grid item xs={4}>
              <FormControl fullWidth size="small">
                <InputLabel sx={{ color: '#FFF' }}>Application</InputLabel>
                <Select
                  value={selectedApplication}
                  onChange={(e) => setSelectedApplication(e.target.value as string)}
                  sx={{ 
                    backgroundColor: '#1E252D', 
                    color: 'white',
                    '& .MuiSelect-icon': { color: 'white' }
                  }}
                >
                  <MenuItem value="all">All Applications</MenuItem>
                  {applications.map((app) => (
                    <MenuItem key={app.appUID} value={app.appName}>
                      {app.appName}
                    </MenuItem>
                  ))}
                </Select>
              </FormControl>
            </Grid>
            
            {/* Report Format */}
            <Grid item xs={4}>
              <FormControl fullWidth size="small">
                <InputLabel sx={{ color: '#FFF' }}>Format</InputLabel>
                <Select
                  value={reportFormat}
                  onChange={(e) => setReportFormat(e.target.value as any)}
                  sx={{ 
                    backgroundColor: '#1E252D', 
                    color: 'white',
                    '& .MuiSelect-icon': { color: 'white' }
                  }}
                >
                  <MenuItem value="csv">CSV</MenuItem>
                  <MenuItem value="excel">Excel</MenuItem>
                  <MenuItem value="pdf">PDF</MenuItem>
                  <MenuItem value="json">JSON</MenuItem>
                </Select>
              </FormControl>
            </Grid>
            
            {/* Date Range */}
            <Grid item xs={4}>
              <TextField
                label="Date Range"
                size="small"
                fullWidth
                value={`${startDate} → ${endDate}`}
                InputProps={{
                  endAdornment: (
                    <InputAdornment position="end">
                      <IconButton onClick={() => {}}>
                        <CalendarTodayIcon sx={{ color: '#FFF' }} />
                      </IconButton>
                    </InputAdornment>
                  ),
                  sx: { color: 'white' }
                }}
                sx={{ backgroundColor: '#1E252D', borderRadius: 1 }}
              />
            </Grid>
            
            {/* Bank ID Search */}
            <Grid item xs={12}>
              <TextField
                label="Search by Bank ID"
                size="small"
                fullWidth
                value={bankId}
                onChange={(e) => setBankId(e.target.value)}
                InputProps={{
                  startAdornment: (
                    <InputAdornment position="start">
                      <SearchIcon sx={{ color: '#FFF' }} />
                    </InputAdornment>
                  ),
                  sx: { color: 'white' }
                }}
                sx={{ backgroundColor: '#1E252D', borderRadius: 1 }}
              />
            </Grid>
            
            {/* Custom Fields */}
            <Grid item xs={12}>
              <Typography variant="subtitle1" sx={{ color: 'white', mb: 1 }}>
                Select Fields to Include
              </Typography>
              <Box sx={{ 
                backgroundColor: '#1E252D', 
                p: 2, 
                borderRadius: 1,
                maxHeight: 200,
                overflowY: 'auto'
              }}>
                <Grid container spacing={2}>
                  {reportFields.map((field) => (
                    <Grid item xs={4} key={field.id}>
                      <FormControlLabel
                        control={
                          <Checkbox
                            checked={field.selected}
                            onChange={() => handleFieldToggle(field.id)}
                            sx={{ color: '#2BCBC1' }}
                          />
                        }
                        label={
                          <Typography sx={{ color: 'white', fontSize: 14 }}>
                            {field.label}
                          </Typography>
                        }
                      />
                    </Grid>
                  ))}
                </Grid>
              </Box>
            </Grid>
            
            {/* Action Buttons */}
            <Grid item xs={12}>
              <Box sx={{ display: 'flex', justifyContent: 'flex-end', gap: 2 }}>
                <Button 
                  variant="outlined" 
                  sx={{ 
                    color: 'white', 
                    borderColor: 'white',
                    '&:hover': { borderColor: '#2BCBC1', color: '#2BCBC1' }
                  }}
                  onClick={handlePreview}
                  disabled={isLoading}
                >
                  Preview
                </Button>
                <Button 
                  variant="contained" 
                  sx={{ backgroundColor: '#2BCBC1', '&:hover': { backgroundColor: '#1da59a' } }}
                  onClick={handleDownload}
                  disabled={isLoading || previewData.length === 0}
                >
                  Download
                </Button>
              </Box>
            </Grid>
          </Grid>
        </Box>
      </div>

      {/* Preview Section */}
      {previewData.length > 0 && (
        <div className={styles.previewSection}>
          <Box sx={{ border: '1px solid #444', p: 2, borderRadius: 1, mt: 2, backgroundColor: '#1A2028' }}>
            <Typography variant="h6" sx={{ color: 'white', mb: 2 }}>
              Preview ({previewData.length} records)
            </Typography>
            
            <Box sx={{ 
              backgroundColor: '#262B36', 
              p: 2, 
              borderRadius: 1,
              maxHeight: 400,
              overflowY: 'auto'
            }}>
              <table className={styles.previewTable}>
                <thead>
                  <tr>
                    {reportFields
                      .filter(f => f.selected)
                      .map(field => (
                        <th key={field.id}>{field.label}</th>
                      ))}
                  </tr>
                </thead>
                <tbody>
                  {previewData.slice(0, 10).map((row, index) => (
                    <tr key={index}>
                      {reportFields
                        .filter(f => f.selected)
                        .map(field => (
                          <td key={`${index}-${field.id}`}>
                            {row[field.id] || "N/A"}
                          </td>
                        ))}
                    </tr>
                  ))}
                  {previewData.length > 10 && (
                    <tr>
                      <td colSpan={reportFields.filter(f => f.selected).length} style={{ textAlign: 'center' }}>
                        ... and {previewData.length - 10} more records
                      </td>
                    </tr>
                  )}
                </tbody>
              </table>
            </Box>
          </Box>
        </div>
      )}
    </div>
  );
};

export default ReportsView;
